CS0 EQU 0640H
P8255_PA EQU CS0 + 00H
P8255_PB EQU CS0 + 02H
P8255_PC EQU CS0 + 04H
P8255_CONTROL EQU CS0 + 06H
P8255_MODE EQU 90H
P8255_INIT EQU 0FFH

P8259_ICW1 EQU 13H
P8259_ICW2 EQU 10H
P8259_ICW3 EQU 04H
P8259_ICW4 EQU 01H
P8259_OCW1 EQU 3FH
P8259_OCW2 EQU 20H
CS_8259 EQU 20H

CODE SEGMENT
ASSUME CS:CODE
MAIN PROC NEAR
;设置8255
MOV DX,P8255_CONTROL
MOV AL,P8255_MODE
OUT DX,AL
MOV DX,P8255_PB
MOV AL,80H
OUT DX,AL
;主程序
LOP:

NOP
JMP LOP
;设置中断向量
CLI
MOV AX,OFFSET INT_IR6
MOV SI,0058H
MOV [SI],AX
MOV AX,CS
MOV SI,005AH
MOV [SI],AX

MOV AX,OFFSET INT_IR7
MOV SI,005CH
MOV [SI],AX
MOV AX,CS
MOV SI,005EH
MOV [SI],AX
STI
;初始化8259
CLI
MOV AL,P8259_ICW1
OUT 20H,AL
MOV AL,P8259_ICW2
OUT 21H,AL
MOV AL,P8259_ICW4
OUT 21H,AL
MOV AL,P8259_OCW1
OUT 21H,AL
MOV AL,P8259_OCW2
OUT 20H,AL
STI
MAIN ENDP

;MIR7中断处理程序
INT_IR7 PROC FAR
STI
MOV BX,0H
MOV DX,P8255_PB
IN AL,DX
CMP AL,80H
JE END1
SHIFT1:
CMP BX,1H
JE END1
CMP AL,80H
JE END1
ROL AL,1H
OUT DX,AL
CALL DELAY
JMP SHIFT1
END1:
MOV BX,1H
IRET
INT_IR7 ENDP

;MIR6中断处理程序
INT_IR6 PROC FAR
STI
MOV BX,0H
MOV DX,P8255_PB
IN AL,DX
CMP AL,1H
JE END2
SHIFT2:
CMP BX,1H
JE END2
CMP AL,80H
JE END2
ROR AL,1H
OUT DX,AL
CALL DELAY
JMP SHIFT2
END2:
MOV BX,1H
IRET
INT_IR6 ENDP

;延时子程序
DELAY PROC NEAR
MOV CX,0FFH
LOOP $
RET
DELAY EDNP
CODE ENDS
END MIAN